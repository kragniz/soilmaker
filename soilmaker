#!/usr/bin/env python
from rpy2.robjects.packages import importr

class Svg(object):
    __header = '''<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   width="2600"
   height="2500">

  <metadata
     id="metadata">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title />
      </cc:Work>
    </rdf:RDF>
  </metadata>

  <defs>
    <style type="text/css"><![CDATA[
      text {
        font-family: Sans;
      }
      path {
        stroke: #000000;
        stroke-width:8;
        stroke-linecap:round;
        fill:none;
      }
    ]]></style>
  </defs>
   <g
     id="profile"
     transform="translate(500,200)">'''

    __footer = '''    <path
       d="M 500,0 500, 2000 250, 2200 0, 2000 0, 0 z"
       id="outline"/>
  </g>
</svg>'''

    __bottom = '''    <g>
      <path style="fill:{colour};stroke:none"
         d="M 500,{start} 500, 2000 250, 2200 0, 2000 0, {start} z"/>
      <g transform="translate(500, {midpoint})">
           <path d="M 0, 0 75, 0"/>
           {textblock}
      </g>
    </g>'''

    __horizon = '''
    <g>
      <rect
         style="fill:{colour};stroke:none"
         width="500"
         height="{hight}"
         x="0"
         y="{start}" />
      <g transform="translate(500, {midpoint})">
           <path d="M 0, 0 75, 0"/>
           {textblock}
      </g>
      <g transform="translate(0,{depth})">
        <path d="M -50, 0 500, 0"/>
        <text font-size="{fontsize}" transform="translate(-60,25)" text-anchor="end">
          {measurement}
        </text>
      </g>
    </g>'''

    def __init__(self):
      self.munsell = importr('munsell')

    def textblock(self, text, fontsize=50, linemax=50):
        line = ''
        lines = []
        for w in text.split():
            if len(line + ' ' + w) < linemax:
                line = line + ' ' + w
            else:
                lines += ['<tspan x="75" dy="{fontsize}">%s</tspan>' % line]
                line = w
        if line: lines += ['<tspan x="75" dy="{fontsize}">%s</tspan>' % line]
        return ('<text font-size="{fontsize}" transform="translate(25,-30)">' +
               '\n'.join(lines) + '</text>').format(fontsize=fontsize)

    def horizon(self, depth, colour, start=0, text=''):
        return self.__horizon.format(start=start,
                                     depth=depth,
                                     hight=depth-start,
                                     measurement=depth/10,
                                     midpoint=(depth+start)/2,
                                     fontsize=50,
                                     textblock=self.textblock(text),
                                     colour=self.colour(colour))

    def bottom(self, start, colour, text=''):
        return self.__bottom.format(start=start,
                                    midpoint=(start+2000)/2,
                                    textblock=self.textblock(text),
                                    colour=self.colour(colour),
                                    )
    def colour(self, mnsl):
      '''Return the hex value of a munsell colour'''
      return self.munsell.mnsl(mnsl)[0]

    def make(self, *args):
        lastHorizon = 0
        horizons = ''
        for h in args:
            if h[0] == '-':
                horizons = self.bottom(int(lastHorizon), h[1], h[2]) + horizons
            else:
                horizons = self.horizon(int(h[0]), h[1], int(lastHorizon), h[2]) + horizons
            lastHorizon = h[0]
        return self.__header + horizons + self.__footer

    def parse(self, text):
        lines = text.split('\n')
        horizons = []
        for l in lines[1:]:
            w = l.split()
            horizons += [(w[0], w[1]+' '+w[2], ' '.join(w[3:]))]
        return horizons

    def formatText(self, texture, horizonDesignation, musell, colour):
        '''"-"" "10YR 3/2" "horizonDesignation" "texture"'''
        return '({horizonDesignation}) {colour} ({munsell}), {texture}.'.formaat(
            horizonDesignation=horizonDesignation,
            colour=colour,
            munsell=munsell,
            texture=texture)


if __name__ == '__main__':
    s = Svg()
    # print s.make(('820', '10YR 7/2', 'Some soil'),
    #              ('1050', '10YR 5/2', 'Some more fnbgf dsf d soil'),
    #              ('-', '10YR 3/2', 'hello this looks nice'))
    print s.parse('''820 10YR 7/2 Some soil
1050 10YR 5/2 Some more fnbgf dsf d soil
- 10YR 3/2 hello this looks nice''')